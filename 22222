<script>
  const character = localStorage.getItem("selectedCharacter") || "герой";
  const intro = localStorage.getItem("intro");
  const stats = JSON.parse(localStorage.getItem("characterStats")) || { strength: 0, dexterity: 0, intelligence: 0, charisma: 0 };

  if (!intro || !character) {
    alert("Спочатку оберіть персонажа!");
    window.location.href = "/";
  }
  document.getElementById("hero").innerText = "Обраний персонаж: " + character;
  document.getElementById("intro").innerText = intro;

  function estimateDifficultyAndStat(action) {
    const text = action.toLowerCase();

    // Сила
    const strengthWords = ["посунути", "підняти", "зламати", "штовхнути"];
    if (strengthWords.some(word => text.includes(word))) return { difficulty: 10, stat: "strength", bonus: stats.strength };

    // Спритність
    const dexterityWords = ["перестрибнути", "залізти", "вкрасти", "сховатися"];
    if (dexterityWords.some(word => text.includes(word))) return { difficulty: 10, stat: "dexterity", bonus: stats.dexterity };

    // Інтелект
    const intelligenceWords = ["головоломка", "замок", "розгадати", "дослідити"];
    if (intelligenceWords.some(word => text.includes(word))) return { difficulty: 12, stat: "intelligence", bonus: stats.intelligence };

    // Харизма
    const charismaWords = ["домовитися", "переконати", "обдурити", "поговорити"];
    if (charismaWords.some(word => text.includes(word))) return { difficulty: 12, stat: "charisma", bonus: stats.charisma };

    // Стандартна дія
    return { difficulty: 6, stat: "none", bonus: 0 };
  }

  async function sendAction() {
    const action = document.getElementById("action").value;
    if (!action.trim()) return;

    const { difficulty, stat, bonus } = estimateDifficultyAndStat(action);
    const dice = Math.floor(Math.random() * 20) + 1;
    const total = dice + bonus;

    log(`\n> Ти пробуєш: ${action}\nКидок d20: ${dice} + бонус (${stat !== "none" ? stat : "немає"}: ${bonus}) = ${total} (складність: ${difficulty})`);

    try {
      const response = await fetch("/gpt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, dice_result: total, difficulty, character })
      });

      const data = await response.json();
      if (data.error) {
        log(`Помилка: ${data.error}`);
        return;
      }

      log(data.reply);
    } catch (error) {
      log(`Помилка під час запиту до сервера: ${error.message}`);
    }

    document.getElementById("action").value = "";
  }

  function log(text) {
    const logDiv = document.getElementById("log");
    logDiv.innerText += text + "\n";
    logDiv.scrollTop = logDiv.scrollHeight;
  }
</script>



@app.route('/gpt', methods=['POST'])
def gpt_response():
    data = request.get_json()
    action = data.get("action")
    result = data.get("dice_result")
    difficulty = data.get("difficulty")
    character = data.get("character", "герой")

    prompt = f"""
Ти — {character} у фентезійному світі. Гравець намагається: "{action}".
Кидок d20 з бонусом: {result} (складність: {difficulty}). 
{"Дія вдалася." if result >= difficulty else "Дія провалилася."}

Опиши наслідок цієї дії коротко (до 5-6 речень), у фентезійному стилі. Не описуй нову ціль — лише реакцію на дію.
"""

    model = genai.GenerativeModel("gemini-2.0-flash")
    response = model.generate_content(prompt)
    return jsonify({ "reply": response.text.strip() })

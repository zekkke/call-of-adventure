<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Call Of Adventure</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 20px;
      background-color: #f0f0f0;
    }
    h2 {
      color: #333;
    }
    #log {
      white-space: pre-line;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      margin-top: 20px;
      background-color: #fff;
      padding: 10px;
      border-radius: 5px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
    }
    .history-entry {
      margin-bottom: 10px;
    }
    .history-entry.action {
      font-style: italic;
      color: #555;
    }
    .history-entry.reply {
      color: #333;
    }
    textarea {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      resize: none;
    }
    textarea:disabled {
      background-color: #f0f0f0;
      color: #888;
      cursor: not-allowed;
    }
    button {
      padding: 10px 20px;
      background-color:rgb(13, 234, 21);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color:rgb(10, 109, 15);
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .end-message button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .end-message {
      margin-top: 20px;
      padding: 10px;
      background-color: #e0ffe0;
      border: 1px solid #4CAF50;
      border-radius: 5px;
      text-align: center;
    }
    .character-info {
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
    }
    .character-info h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .character-info p {
      margin: 5px 0;
    }  
    .character-info #goal {
      font-weight: bold;
      color:rgb(9, 30, 9); 
    }
  </style>
</head>
<body>
  <div class="character-info">
    <h3 id="hero"></h3>
    <p><strong>Твоя ціль:</strong> <span id="goal"></span></p>
    <p><strong>Зброя:</strong> <span id="weapon"></span></p>
    <p><strong>Інвентар:</strong> <span id="inventory"></span></p>
  </div>
  <div id="log" style="white-space: pre-line; border-top: 1px solid #ccc; padding-top: 10px;"></div>

  <hr>
  <textarea id="action" placeholder="Що ти робиш?"></textarea>
  <button id="actionButton" onclick="sendAction()">Спробувати</button>
  <div id="endMessage" class="end-message" style="display: none;"></div>
  <script>
    window.onerror = function(message, source, lineno, colno, error) {
      console.error(`Помилка: ${message} у файлі ${source}:${lineno}:${colno}`);
      alert("Виникла помилка. Спробуйте перезапустити гру.");
    };
    const character = localStorage.getItem("selectedCharacter") || "герой";
    const intro = localStorage.getItem("intro");
    const goal = localStorage.getItem("goal");
    const stats = JSON.parse(localStorage.getItem("characterStats") || "{}") || { strength: 0, dexterity: 0, intelligence: 0, charisma: 0, weapon: "Немає зброї", inventory: [] };
    let history = JSON.parse(localStorage.getItem("gameHistory")) || [];
    let isAdventureCompleted = localStorage.getItem("isAdventureCompleted") === "true";
    let inventory = JSON.parse(localStorage.getItem("inventory")) || stats.inventory || []; 
  
    if (!intro || !character || !goal) {
      alert("Спочатку оберіть персонажа або ціль не визначена!");
      window.location.href = "/";
    }
    const previousCharacter = localStorage.getItem("previousCharacter");
    if (previousCharacter && previousCharacter !== character) {
      history = [];
      localStorage.setItem("gameHistory", JSON.stringify(history));
      localStorage.setItem("isAdventureCompleted", "false");
      localStorage.setItem("inventory", JSON.stringify(stats.inventory || []));
      inventory = stats.inventory || [];
      isAdventureCompleted = false;
    }
    localStorage.setItem("previousCharacter", character);
    document.getElementById("hero").innerText = "Обраний персонаж: " + character; 
    document.getElementById("goal").innerText = goal; 
    document.getElementById("weapon").innerText = stats.weapon || "Немає зброї"; 
    document.getElementById("inventory").innerText = inventory.join(", ") || "Інвентар порожній"; 
    const logDiv = document.getElementById("log");
    const introEntry = document.createElement("div");
    introEntry.className = "history-entry reply";
    introEntry.textContent = intro;
    logDiv.appendChild(introEntry);
    history.forEach(entry => {
      const actionEntry = document.createElement("div"); 
      actionEntry.className = "history-entry action"; 
      actionEntry.textContent = entry.action; 
      logDiv.appendChild(actionEntry); 
      const replyEntry = document.createElement("div"); 
      replyEntry.className = "history-entry reply"; 
      replyEntry.textContent = entry.reply; 
      logDiv.appendChild(replyEntry); 
    }); 
    logDiv.scrollTop = logDiv.scrollHeight;
    if (isAdventureCompleted) {
      endGame(localStorage.getItem("finalDescription") || "Пригода завершена!");
    }
    document.getElementById("action").addEventListener("keypress", function(event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendAction();
      }
    });
    function estimateDifficultyAndStat(action) {
      const actionText = action.toLowerCase(); 
      const strengthWords = [
        "посунути", "підняти", "зламати", "штовхнути", "вдарити", "втримати",
        "тягнути", "відштовхнути", "виштовхнути", "перемогти", "розбити",
        "зрушити", "розірвати", "відкрити силою", "вибити", "протиснутися",
        "винести", "перекинути", "відтягнути", "утримати", "підперти",
        "піднести", "кинути", "перекинутись", "переламати", "втиснути",
        "вхопити", "утримати", "вирвати", "стиснути"];
      if (strengthWords.some(word => actionText.includes(word))) return { difficulty: 10, stat: "strength", bonus: stats.strength };
      const dexterityWords = ["перестрибнути", "стрибнути", "залізти", "вкрасти", "сховатися", "ухилитися",
        "прокрастися", "пробратися", "підкрастися", "зіскочити", "вислизнути",
        "спіймати", "втекти", "перекотитися", "забратися", "вискочити", "проскочити",
        "маневрувати", "обійти", "зістрибнути", "зісковзнути", "піднятися",
        "втрапити", "закинути", "перекинути", "підкрадатися", "оббігти"];
      if (dexterityWords.some(word => actionText.includes(word))) return { difficulty: 10, stat: "dexterity", bonus: stats.dexterity };
      const intelligenceWords = ["прочитати", "відкрити замок", "розгадати", "дослідити", "вивчити", "зрозуміти", 
        "вгадати", "розв’язати", "запам’ятати",
        "пригадати", "аналізувати", "вирахувати", "вираховувати", "прорахувати",
        "пояснити", "вираховувати", "вирахував", "розпізнати", "спостерігати",
        "розшифрувати", "перевірити", "дослідити", "виявити", "інтерпретувати",
        "застосувати знання", "використати логіку", "вирахувати логіку", "логічно мислити"];
      if (intelligenceWords.some(word => actionText.includes(word))) return { difficulty: 10, stat: "intelligence", bonus: stats.intelligence };
      const charismaWords = ["переконати", "вмовити", "обдурити", "залякати", "підкупити", "зачарувати",
        "вплинути", "вразити", "спокусити", "надихнути", "домовитися", "запросити",
        "обманути", "зажартувати", "посміхнутися", "поговорити", "промовити",
        "завести розмову", "завоювати", "налагодити контакт", "виманити",
        "маніпулювати", "висміяти", "заспокоїти", "викликати довіру"];
      if (charismaWords.some(word => actionText.includes(word))) return { difficulty: 10, stat: "charisma", bonus: stats.charisma };
      const simple = ["запалити", "взяти", "узяти", "підібрати", "відкрити", "закрити", "оглянути",
        "поглянути", "подивитися", "перевірити", "роздивитися", "протерти",
        "використати", "натиснути", "посвітити", "зачинити", "вимкнути", "увімкнути",
        "знайти", "записати", "зламати гілку", "скинути", "відтягнути", "розсунути",
        "взяти в руки", "покласти", "випити", "з'їсти", "відкусити", "достати",
        "прочитати", "спитати", "набрати", "обернутися", "озирнутися", "покликати",
        "достати з кишені", "вихопити", "відсунути", "торкнутись", "помахати"];
      const medium = ["перестрибнути", "перелізти", "вкрасти", "сховатися", "вдарити", "спробувати обманути",
        "переконати", "розпитати", "переміститися тихо", "втекти", "залякати", "кинути",
        "перекинути", "залізти вгору", "вивести з рівноваги", "вдарити предметом", "підштовхнути",
        "підсунути", "витягнути", "обійти пастку", "ухилитися", "підкрастися", "розгледіти",
        "відшукати", "перетягнути", "націлитися", "кинути ніж", "спіймати", "вибити",
        "швидко зреагувати", "спробувати вмовити", "провести ритуал", "штовхнути двері"];
      const hard = ["переконати", "знищити", "вивести з рівноваги", "обдурити", "протиснутися силою",
        "перемогти великого ворога", "зламати заклинання", "розгадати древню головоломку",
        "переконати короля", "вдарити критично", "знешкодити вибухівку", "викрасти з-під носа",
        "перекинути важкий об’єкт", "обманути натовп", "пройти невидимий лабіринт",
        "використати заборонене закляття", "обдурити духа", "вирватися з кайданів",
        "перемогти монстра самостійно", "вплинути на розум іншого", "воскресити", "стати невидимим",
        "зламати магічний захист", "вивести з трансу", "зупинити ритуал", "обернути ворогів проти себе"];
      if (hard.some(word => actionText.includes(word))) return { difficulty: 15, stat: "none", bonus: 0 };
      if (medium.some(word => actionText.includes(word))) return { difficulty: 10, stat: "none", bonus: 0 };
      if (simple.some(word => actionText.includes(word))) return { difficulty: 6, stat: "none", bonus: 0 };
      return { difficulty: 2, stat: "none", bonus: 0 };
    }
    async function sendAction() {
      const action = document.getElementById("action").value;
      if (!action.trim()) return;
      if (isAdventureCompleted) {
        log("Пригода вже завершена! Почни нову гру.");
        return;
      }
      const { difficulty, stat, bonus } = estimateDifficultyAndStat(action);
      const dice = Math.floor(Math.random() * 20) + 1;
      const total = dice + bonus; 
      const actionText = `> Ти пробуєш: ${action}\nКидок d20: ${dice} + бонус (${stat !== "none" ? stat : "немає"}: ${bonus}) = ${total} (складність: ${difficulty})`;
      const actionEntry = document.createElement("div");
      actionEntry.className = "history-entry action";
      actionEntry.textContent = actionText;
      logDiv.appendChild(actionEntry);
      try {
        const response = await fetch("/gpt", {
          headers: {
            "Content-Type": "application/json"
          },
          method: "POST",
          body: JSON.stringify({ action, dice_result: total, difficulty, character, intro, history, weapon: stats.weapon, inventory }) 
        });
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        if (data.error) {
          log(`Помилка: ${data.error}`);
          return;
        }
        if (typeof data.reply === "string") {
          const replyEntry = document.createElement("div");
          replyEntry.className = "history-entry reply";
          replyEntry.textContent = data.reply;
          logDiv.appendChild(replyEntry);
        } else {
          log("Отримано некоректну відповідь від сервера.");
        }
        history.push({ action: actionText, reply: data.reply });
        localStorage.setItem("gameHistory", JSON.stringify(history));
        if (data.newItems && data.newItems.length > 0) {
          inventory = inventory.concat(data.newItems);
          localStorage.setItem("inventory", JSON.stringify(inventory));
          document.getElementById("inventory").innerText = inventory.join(", ") || "Інвентар порожній";
          const inventoryEntry = document.createElement("div");
          inventoryEntry.className = "history-entry reply";
          inventoryEntry.textContent = `[Нові предмети]: ${data.newItems.join(", ")} додано до інвентарю!`;
          logDiv.appendChild(inventoryEntry);
        }
        if (data.isGoalAchieved) {
          isAdventureCompleted = true;
          localStorage.setItem("isAdventureCompleted", "true");
          localStorage.setItem("finalDescription", data.finalDescription); 
          endGame(data.finalDescription);
        }
        logDiv.scrollTop = logDiv.scrollHeight;
      } catch (error) {
        log(`Помилка під час запиту до сервера: ${error.message}`);
      }
      document.getElementById("action").value = "";
    }
    function endGame(finalDescription = "") {
      const actionButton = document.getElementById("actionButton");
      const actionInput = document.getElementById("action");
      const endMessageDiv = document.getElementById("endMessage");
      if (!actionButton || !actionInput || !endMessageDiv) {
        console.error("One or more elements not found: actionButton, actionInput, or endMessageDiv");
        return;
      }
      actionButton.disabled = true;
      actionInput.disabled = true;
      endMessageDiv.style.display = "block";
      endMessageDiv.innerHTML = `
        <h3>Пригода завершена!</h3>
        <p></p>
        <button onclick="startNewGame()">Почати нову пригоду</button>
      `;
      endMessageDiv.querySelector("p").textContent = finalDescription;
      const finalEntry = document.createElement("div");
      finalEntry.className = "history-entry reply";
      finalEntry.textContent = finalDescription;
      logDiv.appendChild(finalEntry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    function startNewGame() {
      localStorage.removeItem("selectedCharacter");
      localStorage.removeItem("intro");
      localStorage.removeItem("goal");
      localStorage.removeItem("characterStats");
      localStorage.removeItem("gameHistory");
      localStorage.removeItem("isAdventureCompleted");
      localStorage.removeItem("inventory");
      localStorage.removeItem("finalDescription");
      localStorage.removeItem("previousCharacter");
      window.location.href = "/";
    }  
    function log(text) {
      const logDiv = document.getElementById("log");
      const entry = document.createElement("div");
      entry.className = "history-entry reply";
      entry.textContent = text;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  </script>
</body>
</html>
